<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Panel Selector</title>
  <!-- link to your new styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="toolbar">
    <input type="file" id="fileInput" accept="application/pdf" />
    <button id="btnAdd">Add Panel</button>
    <button id="btnRemove">Remove Panel</button>
    <button id="btnClear">Clear All Panels</button>
    <button id="btnConfirm">Confirm Selection</button>
  </div>

  <div id="container">
    <div style="position: relative; display: inline-block;">
      <canvas id="pdfCanvas"></canvas>
      <canvas id="overlay"></canvas>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
  <script type=module>
    import {set} from 'https://cdn.jsdelivr.net/npm/idb-keyval@6/+esm';

    // PDF.js setup
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.worker.min.js';

    // DOM refs
    const fileInput = document.getElementById('fileInput');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const overlay   = document.getElementById('overlay');
    const pdfCtx    = pdfCanvas.getContext('2d');
    const octx      = overlay.getContext('2d');
    const btnAdd    = document.getElementById('btnAdd');
    const btnRemove = document.getElementById('btnRemove');
    const btnClear  = document.getElementById('btnClear');
    const btnConfirm= document.getElementById('btnConfirm');

    // State
    let pdfPage, scale = 1.5;
    let mode = 'none';    // 'none' | 'add' | 'remove'
    let startPt = null, activeRect = null, rects = [];

    // Drawing helpers
    function drawAll() {
      octx.clearRect(0,0,overlay.width,overlay.height);
      octx.strokeStyle = 'red'; octx.lineWidth = 2;
      rects.forEach(r => octx.strokeRect(r.x, r.y, r.w, r.h));
      if (activeRect) {
        octx.strokeStyle = 'blue';
        octx.strokeRect(activeRect.x, activeRect.y, activeRect.w, activeRect.h);
      }
    }

    function setMode(newMode) {
      mode = newMode;

      // 1) Toggle body classes
      document.body.classList.toggle('mode-add',    mode === 'add');
      document.body.classList.toggle('mode-remove', mode === 'remove');

      // 2) Update your toolbar button highlighting as before
      btnAdd.classList.toggle('active',   mode === 'add');
      btnRemove.classList.toggle('active',mode === 'remove');

      // 3) If we leave “add” mode, clear any half-drawn rectangles
      if (mode !== 'add') {
        startPt = activeRect = null;
        drawAll();
      }
    }

    // Load & render PDF
      fileInput.addEventListener('change', async e => {
        
      const file = e.target.files[0];
      console.log("fileInput.change handler fired");
      if (!file) return;
      // 1) Read once as ArrayBuffer for PDF.js
      const arrayBuffer = await file.arrayBuffer();

      // PDF.js rendering
      const pdf     = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      pdfPage       = await pdf.getPage(1);
      const v       = pdfPage.getViewport({ scale });
      [pdfCanvas, overlay].forEach(c => {
        c.width  = v.width;
        c.height = v.height;
      });
      await pdfPage.render({ canvasContext: pdfCtx, viewport: v }).promise;
      rects = [];
      setMode('none');
      drawAll();
      
      // Storage in IndexedDB
      await set('current-pdf', file);
      console.log('PDF saved to IDB as "current-pdf"');
    });
    
    // Switch modes & clear
      btnAdd.addEventListener('click',    () => setMode(mode==='add'?'none':'add'));
      btnRemove.addEventListener('click', () => setMode(mode==='remove'?'none':'remove'));
      btnClear.addEventListener('click',  () => {
        rects = []; startPt = activeRect = null; setMode('none'); drawAll();
    });

    // 3) Draw & remove rectangles
    overlay.addEventListener('mousedown', e => {
      if (mode !== 'add') return;
      startPt = { x:e.offsetX, y:e.offsetY };
    });
    overlay.addEventListener('mousemove', e => {
      if (mode!=='add' || !startPt) return;
      const x1=Math.min(startPt.x,e.offsetX),
            y1=Math.min(startPt.y,e.offsetY),
            w =Math.abs(startPt.x-e.offsetX),
            h =Math.abs(startPt.y-e.offsetY);
      activeRect = { x:x1, y:y1, w, h };
      drawAll();
    });
    overlay.addEventListener('mouseup', () => {
      if (mode==='add' && activeRect) {
        rects.push(activeRect);
        activeRect = startPt = null;
        drawAll();
      }
    });
    overlay.addEventListener('click', e => {
      if (mode!=='remove') return;
      const px=e.offsetX, py=e.offsetY;
      for (let i=rects.length-1;i>=0;i--){
        const r=rects[i];
        if (px>=r.x&&px<=r.x+r.w&&py>=r.y&&py<=r.y+r.h) {
          rects.splice(i,1); drawAll(); break;
        }
      }
    });

    // 4) Confirm & navigate
    btnConfirm.addEventListener('click', () => {
      if (!rects.length) return alert('Select panels first');
      const panels = rects.map((r,i)=>{
        const tmp=document.createElement('canvas');
        tmp.width=r.w; tmp.height=r.h;
        tmp.getContext('2d').drawImage(
          pdfCanvas, r.x, r.y, r.w, r.h,
          0, 0, r.w, r.h
        );
        return { id: i+1, beforeUrl: tmp.toDataURL(), coords: r };
      });
      sessionStorage.setItem('panelsToRefine', JSON.stringify(panels));
      window.location.href = 'refine.html';
    });
  </script>
</body>
</html>
