<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="/frontend/style.css">
  <meta charset="UTF-8">
  <title>Refine Your Panels</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .panel-card { position: relative; margin-bottom: 30px; border: 1px solid #ccc; padding: 10px; }
    .panel-card h2 { margin: 0 0 10px; }
    .images { display: flex; gap: 20px; }
    .images img { max-width: 100%; height: auto; display: block; }
    .before-container, .after-container { flex: 1; text-align: center; }
    .spinner { font-style: italic; }
    .remove-panel { position: absolute; top: 10px; right: 10px; }
    #btnSendRefine { margin-bottom: 20px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h1>Refine Your Panels</h1>
  <button id="btnSendRefine">Send for Refine</button>
  <button id="btnPasteEdited" disabled>Paste Edited into PDF</button>
  <div id="panelList"></div>

  <script>
    window.addEventListener('unhandledrejection', event => {
        // If itâ€™s the chain-disconnected error, swallow it
        if (event.reason && event.reason.code === 4900) {
             console.debug('Suppressed injected provider error:', event.reason.message);
         event.preventDefault();
        }
    }); 
    
    const API_BASE = 'http://localhost:8000';
    const list = document.getElementById('panelList');
    const btn  = document.getElementById('btnSendRefine');
    const btnPasteEdited = document.getElementById('btnPasteEdited');

    // Helper to enable the Paste Edited button when all panels are ready
    function maybeEnablePaste() {
      const afterImgs = Array.from(document.querySelectorAll('.after-container img'));
      const allLoaded = afterImgs.length > 0
        && afterImgs.every(img => img.src && img.style.display !== 'none');
      btnPasteEdited.disabled = !allLoaded;
    } 

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 1) Load & debug panels
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    console.log("ğŸ” refine.html script loaded");
    const raw = sessionStorage.getItem('panelsToRefine');
    console.log("ğŸ” raw panelsToRefine:", raw);
    let panels = JSON.parse(raw || '[]');
    console.log("ğŸ” panels array:", panels);

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 2) Render panels
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function renderPanels() {
      list.innerHTML = '';

      if (!panels.length) {
        // Emptyâ€state markup + Back button
        list.innerHTML = `
          <div class="no-panels" style="text-align:center; padding:2rem;">
            <p>No panels to refine. Go back and select some.</p>
            <button id="btnGoBack"> Back to Selector</button>
          </div>
        `;

      // Wire up the Back button
    document
      .getElementById('btnGoBack')
      .addEventListener('click', () => {
      window.location.href = 'index.html';
      });
      
    document
      .getElementById('btnPasteEdited')
      .addEventListener('click', () => {
      window.location.href = 'merge.html';
    });
    return;
    }


    panels.forEach(panel => {
      console.log("rendering panel", panel.id);
      const card = document.createElement('div');
      card.className = 'panel-card';
      card.dataset.id = panel.id;

    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.className = 'remove-panel';
    removeBtn.addEventListener('click', () => {
        panels = panels.filter(p => p.id !== panel.id);
        sessionStorage.setItem('panelsToRefine', JSON.stringify(panels));
        renderPanels();
    });
    card.appendChild(removeBtn);

    // Title
    const title = document.createElement('h2');
    title.textContent = `Panel ${panel.id}`;
    card.appendChild(title);

    // Before / After containers
    const imagesDiv = document.createElement('div');
    imagesDiv.className = 'images';

    // BEFORE
    const beforeContainer = document.createElement('div');
    beforeContainer.className = 'before-container';
    beforeContainer.innerHTML = `
      <p>Before</p>
      <img src="${panel.beforeUrl}" />
    `;

    // AFTER
    const afterContainer = document.createElement('div');
    afterContainer.className = 'after-container';
    if (panel.afterUrl) {
      // we already have an edited versionâ€”show it
      afterContainer.innerHTML = `
        <p>After</p>
        <img src="${panel.afterUrl}" />
      `;
    } else {
      // still pendingâ€”show spinner and keep the img hidden
      afterContainer.innerHTML = `
        <p>After</p>
        <span class="spinner">â³ Pending</span>
        <img style="display:none" />
      `;
    }

    imagesDiv.append(beforeContainer, afterContainer);
    card.appendChild(imagesDiv);

    const editSection = document.createElement('div');
    editSection.className = 'edit-section';
    editSection.innerHTML = `
      <textarea class="edit-prompt" 
        placeholder="Enter a follow-up promptâ€¦" 
        rows="2"></textarea>
      <button class="btnEdit">Send for Edit</button>
      <span class="edit-spinner" style="display:none">â³ Pending editâ€¦</span>
    `;

    card.appendChild(editSection);
    list.appendChild(card);
    });
    }
    renderPanels();

      list.addEventListener('click', async (e) => {
      if (!e.target.classList.contains('btnEdit')) return;

      const btn     = e.target;
      const card    = btn.closest('.panel-card');
      const panelId = card.dataset.id;
      const panel   = panels.find(p => p.id == panelId);
      const prompt  = card.querySelector('.edit-prompt').value.trim();
      const spinner = card.querySelector('.edit-spinner');
      const afterImg= card.querySelector('.after-container img');

      if (!prompt) {
        alert('Please enter a prompt for the edit.');
        return;
      }

      // disable UI
      btn.disabled      = true;
      spinner.style.display = 'inline';

      try {
        // 3) Call your edit endpoint
        const res = await fetch(`${API_BASE}/api/sketch/edit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image_id: panel.imageId,
            prompt:   prompt
          })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { job_id } = await res.json();

        // 4) Poll for the edit result
        startPollingEdit(panelId, job_id);
      } catch (err) {
        console.error('Edit enqueue error:', err);
        spinner.textContent = 'âŒ Error';
        btn.disabled = false;
      }
    });

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 3) Send for Refine + Polling
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    btn.addEventListener('click', () => {
        btn.disabled = true;
        btn.textContent = 'Processingâ€¦';

        panels.forEach(panel => {
        fetch(panel.beforeUrl)
            .then(r => r.blob())
            .then(blob => {
            const fd = new FormData();
            fd.append('file', blob, `panel-${panel.id}.png`);
            return fetch(`${API_BASE}/api/sketch/refine`, {
                method: 'POST',
                body: fd
            });
            })
            .then(r => r.json())
            .then(({ job_id, image_id }) => {
            panel.jobId = job_id;
            panel.imageId = image_id;
            console.log(`ğŸš€ panel ${panel.id} job:`, job_id);
            startPolling(panel.id, job_id);
            })
            .catch(err => console.error('Enqueue error:', err));
        });
    });

    function startPolling(panelId, jobId) {
        const card    = document.querySelector(`.panel-card[data-id="${panelId}"]`);
        const spinner = card.querySelector('.spinner');
        const afterImg= card.querySelector('.after-container img');

        console.log(`â–¶ï¸ startPolling(panelId=${panelId}, jobId=${jobId})`);

        const interval = setInterval(async () => {
        const statusUrl = `${API_BASE}/api/sketch/status/${jobId}`;
        console.log("â±ï¸ polling", statusUrl);

        let res, data;
        try {
        res = await fetch(statusUrl);
        } catch (err) {
        console.error("âŒ fetch failed:", err);
        spinner.textContent = 'âŒ Network error';
        clearInterval(interval);
        return;
        }

        if (!res.ok) {
        const txt = await res.text().catch(()=>"<no body>");
        console.error("âŒ HTTP", res.status, txt);
        spinner.textContent = `âŒ ${res.status}`;
        clearInterval(interval);
        return;
        }

        try {
        data = await res.json();
        } catch (err) {
        console.error("âŒ invalid JSON:", err);
        spinner.textContent = 'âŒ Bad JSON';
        clearInterval(interval);
        return;
        }

        console.log("ğŸ”„ status response:", data);
        // inspect the raw payload, maybe it's data.imageUrl or data.staticUrl
        const status = data.status;
        const imgKey = data.url !== undefined
        ? "url"
        : data.imageUrl !== undefined
            ? "imageUrl"
            : Object.keys(data).find(k => typeof data[k]==="string" && data[k].startsWith("/"));

        const urlVal = data[imgKey];
        console.log("ğŸ“¦ interpreted:", { status, imgKey, urlVal });

        if (status === 'SUCCESS' && urlVal) {
          clearInterval(interval);
          const fullUrl = `${API_BASE}${urlVal.startsWith('/') ? urlVal : '/' + urlVal}`;
          console.log("âœ… SUCCESS! setting <img> src to", fullUrl);
          spinner.style.display = 'none';
          afterImg.src = fullUrl;
          afterImg.style.display = 'block';

          const panel = panels.find(p => p.id == panelId);
          if (panel) {
            panel.afterUrl = fullUrl;
            sessionStorage.setItem('panelsToRefine', JSON. stringify(panels));
          }
          // Try to enable paste
          maybeEnablePaste();
        }

        else if (status === 'FAILURE') {
          clearInterval(interval);
          spinner.textContent = 'âŒ Error';
        }
        else {
          spinner.textContent = status;
        }
      }, 2000);
    }

    btnPasteEdited.addEventListener('click', () => {
      if (!btnPasteEdited.disabled) {
        window.location.href = 'merge.html';
      }
    }); 

    function startPollingEdit(panelId, jobId) {
        const card        = document.querySelector(`.panel-card[data-id="${panelId}"]`);
        const editSpinner = card.querySelector('.edit-spinner');
        const btnEdit     = card.querySelector('.btnEdit');
        const afterImg    = card.querySelector('.after-container img');

        const interval = setInterval(async () => {
        try {
          const res = await fetch(`${API_BASE}/api/sketch/status/${jobId}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const { status, url } = await res.json();

          if (status === 'SUCCESS' && url) {
            clearInterval(interval);
            editSpinner.style.display = 'none';
            btnEdit.disabled = false;

            // swap in the new version
            const fullUrl = `${API_BASE}${url.startsWith('/') ? url : '/' + url}`;
            afterImg.src = fullUrl;
          }
          else if (status === 'FAILURE') {
            clearInterval(interval);
            editSpinner.textContent = 'âŒ Edit failed';
            btnEdit.disabled = false;
          }
          else {
            editSpinner.textContent = status;
          }
        } catch (err) {
          console.error('Polling edit error:', err);
          clearInterval(interval);
          editSpinner.textContent = 'âŒ Error';
          btnEdit.disabled = false;
        }
      }, 2000);
    }


</script>
</body>
</html>